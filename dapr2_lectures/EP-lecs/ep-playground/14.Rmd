---
title: "14 Playground â€“ Interactions with manual contrasts, pairwise comparisons"
output: 
  html_notebook:
    toc: true
---

```{r setup}
library(tidyverse)
library(emmeans)
library(interactions)  # for probe_interactions() plot

hosp <- read_csv("../../data/hospital.csv") |>
  mutate(
    Treatment = case_when(
      Treatment == 'TreatA' ~ 'Meds',
      Treatment == 'TreatB' ~ 'EMDR',
      Treatment == 'TreatC' ~ 'CBT',
    ),
    Treatment = factor(Treatment),
    Hospital = factor(Hospital),
  )

# get group means
mean_Meds_1 <- mean(filter(hosp, Treatment == 'Meds', Hospital == 'Hosp1')$SWB)
mean_EMDR_1 <- mean(filter(hosp, Treatment == 'EMDR', Hospital == 'Hosp1')$SWB)
mean_CBT_1  <- mean(filter(hosp, Treatment == 'CBT',  Hospital == 'Hosp1')$SWB)
mean_Meds_2 <- mean(filter(hosp, Treatment == 'Meds', Hospital == 'Hosp2')$SWB)
mean_EMDR_2 <- mean(filter(hosp, Treatment == 'EMDR', Hospital == 'Hosp2')$SWB)
mean_CBT_2  <- mean(filter(hosp, Treatment == 'CBT',  Hospital == 'Hosp2')$SWB)
```


# Plot the data

Story: different ways of treating patients with depression.

A = antidepressants
B = EMDR
C = CBT

```{r}
hosp |>
  ggplot(aes(x = Treatment, y = SWB, colour = Treatment, fill = Treatment)) +
  geom_violin(alpha = 0.5) +
  geom_jitter(alpha = 0.5) +
  facet_wrap(~ Hospital)
```

# Fit model

```{r}
m1 <- lm(SWB ~ Treatment * Hospital, data = hosp)
```


# Manual post-hoc contrasts and interactions

We want to know whether there's a difference in how effective talk therapies vs. medications are, across the two hospitals.

- CBT and EMDR vs. Meds


## Plot the contrast we want to test

```{r}
hosp |>
  mutate(
    TalkTherapy = ifelse(
      Treatment == 'Meds',
      'No',
      'Yes'
    )
  ) |>
  ggplot(aes(x = TalkTherapy, y = SWB, colour = TalkTherapy, fill = TalkTherapy)) +
  geom_violin(alpha = 0.5) +
  geom_jitter(alpha = 0.5) +
  facet_wrap(~ Hospital) +
  stat_summary(geom = 'pointrange', colour = 'black') +
  NULL
```


## Get estimated marginal means

```{r}
m1_emm <- emmeans(m1, ~Treatment * Hospital)
m1_emm
```


## Create manual contrasts

Step 1: Create manual contrasts for each of the things we want to compare.

Step by step from before, end up with

```{r}
treat_contrast <- c(
  'CBT' = -1/2,
  'EMDR' = -1/2,
  'Meds' = 1
)

hosp_contrast <- c(
  'Hosp1' = 1,
  'Hosp2' = -1
)
```

Step 2: To get the correct contrast coding for the interaction, combine these two predictors by getting the "outer product".
The column that appears first in the `emmeans()` table should be first in this list.

(IRL fill in matrix cell by cell, so students see where the numbers come from)

```{r}
ixn_contrast <- outer(treat_contrast, hosp_contrast)
ixn_contrast
```

We need this in a single list of numbers in the same order as the emmeans table.
Because the first emmeans col came first in the outer product, we can just use `as.vector()`  to flatten the matrix, and it will be in the right order.

```{r}
ixn_contrast |> as.vector()
```


Or if you'd prefer, you can write it out manually:

```{r}
ixn_comp <- list(
  "Treat:Hosp" =
    c(
       -0.5,       # CBT  Hosp1 
       -0.5,       # EMDR Hosp1
          1,       # Meds Hosp1
        0.5,       # CBT  Hosp2
        0.5,       # EMDR Hosp2
         -1        # Meds Hosp2
    )
)
```


Test the contrast using `contrast()` from emmeans.

```{r}
ixn_contrast_test <- contrast(m1_emm, ixn_comp)
ixn_contrast_test
```

- We can reject the H0 that there's no difference between hospitals in the effectiveness of talk therapies vs. medication.
- Symmetrically, we can reject the H0 that the relationship between talk therapies vs. medication is the same in both hospitals.


Where does this number 3.73 come from?

It's the sum of all of the group means, each multiplied by the coding from our matrix.

```{r}
ixn_contrast

1 * mean_Meds_1 +
  -1   * mean_Meds_2 +
  -0.5 * mean_EMDR_1 +
   0.5 * mean_EMDR_2 +
  -0.5 * mean_CBT_1 +
   0.5 * mean_CBT_2
```

It's positive, so that means that the means that received positive weights are bigger than the means that received negative weights.


# Multiple comparisons

## get pairwise comparisons with emmeans

(By default, Tukey adjustment)

## No adjustment

```{r}
pair_comp <- pairs(m1_emm, adjust = 'none')

#examine output
pair_comp

plot(pair_comp)
```

All but two comparisons are "significant".


## Bonferroni

```{r}
pair_comp <- pairs(m1_emm, adjust = 'bonferroni')

#examine output
pair_comp

plot(pair_comp)
```

## Tukey

```{r}
pair_comp <- pairs(m1_emm, adjust = 'tukey')

#examine output
pair_comp

plot(pair_comp)
```

## Editorialising

Why do I think this is not a great thing to do?
It encourages poor scientific practice like HARKing (Hypothesising After Results are Known).



