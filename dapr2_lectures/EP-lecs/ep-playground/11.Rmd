---
title: "11 Playground â€“ Interactions num cat, centering"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(interactions)  # for probe_interactions() plot

salary <- read_csv("../../data/salary_lec.csv", show_col_types = FALSE) |>
  mutate(
    envt = factor(ifelse(dept == 1, 'nature', 'urban'))
  )

# make the acct slope a bit steeper to illustrate the point better
# and rename/relabel the data so it's about time outdoors and not salary
outdoors <- salary |>
  mutate(
    salary_aug = ifelse(
      envt == 'nature',
      salary + (service^2)/1.5 - 10,
      salary
    ),
    wellbeing = salary_aug
  ) |>
  rename(
    outdoor_time = service
  ) |>
  select(wellbeing, envt, outdoor_time)
```


# Plot data

```{r}
palette_probe <- c('#4ab8fc', '#ff7b01')

outdoors |>
  ggplot(aes(x = outdoor_time, y = wellbeing, colour = envt)) +
  geom_point(size = 5) +
  geom_smooth(method = 'lm', se = F) +
  # facet_wrap(~ envt) +
  # theme(legend.position = 'none') +
  scale_color_manual(values = palette_probe) +
  NULL
```




`envt`:

- 1 = urban
- 0 = nature

```{r}
contrasts(outdoors$envt)
```


`wellbeing`:

- wellbeing in thosuands of pounds


`outdoor_time`:

- years of outdoor_time



# Model: no interaction

```{r}
m1 <- lm(wellbeing ~ outdoor_time + envt, data = outdoors)
summary(m1)
```

```{r warning=F}
outdoors_probedat <- outdoors |>
  mutate(
    pred = outdoor_time,
    modx_group = envt
  )
  
plot_m1_probe <- probe_interaction(
  model = m1,
  pred = outdoor_time,
  modx = envt,
  interval = T
)$interactplot +
  geom_point(data = outdoors_probedat, size = 5)

plot_data_probe <- plot_m1_probe

plot_data_probe$layers[[1]] <- NULL
plot_data_probe$layers[[1]] <- NULL
```

```{r}
plot_m1_probe
```

- blue line: too high at beginning, too low at end
- orange line: too low at beginning, too high at end

meeting in the middle means that neither line fits the data very well



## plot raw data

```{r}
plot_data_probe
```

## Compute simple slopes

```{r}
coef(m1)
```


Compute simple slopes.

$$
\begin{align}
\widehat{wellbeing} &= \beta_0 + (\beta_1 \cdot outdoor_time) + (\beta_2 \cdot envt) \\
\widehat{wellbeing} &= 19    + (7.8 \cdot outdoor_time)     + (-26.2 \cdot envt) \\ 
\end{align}
$$

When $envt = 0$ (nature):

$$
\begin{align}
\widehat{wellbeing}_{envt=0} &= 19    + (7.8 \cdot outdoor_time)     + (-26.2 \cdot 0) \\
\widehat{wellbeing}_{envt=0} &= 19    + (7.8 \cdot outdoor_time)      \\
\end{align}
$$
When $envt = 1$ (urban):

$$
\begin{align}
\widehat{wellbeing}_{envt=1} &= 19    + (7.8 \cdot outdoor_time)     + (-26.2 \cdot 1) \\
\widehat{wellbeing}_{envt=1} &= 19 - 26.2   + (7.8 \cdot outdoor_time)      \\
\widehat{wellbeing}_{envt=1} &= 9   + (7.8 \cdot outdoor_time)      \\
\end{align}
$$



# Model: with interaction

```{r}
m2 <- lm(wellbeing ~ outdoor_time + envt + outdoor_time:envt, data = outdoors)
summary(m2)
```


## Compute simple slopes

```{r}
coef(m2)
```


### By hand

$$
\begin{align}
\widehat{wellbeing} &= \beta_0 + (\beta_1 \cdot serv) + (\beta_2 \cdot envt) + (\beta_3 \cdot serv \cdot envt)\\
\widehat{wellbeing} &= -3.4    + (12.3 \cdot serv)     + (20.3 \cdot envt)    + (-9.6 \cdot serv \cdot envt)\\
\end{align}
$$


When $envt = 0$ (nature):

$$
\begin{align}
\widehat{wellbeing}_{acct} &= -3.4    + (12.3 \cdot serv)     + (20.3 \cdot envt)    + (-9.6 \cdot serv \cdot envt)\\
\widehat{wellbeing}_{acct} &= -3.4    + (12.3 \cdot serv)     + (20.3 \cdot 0)    + (-9.6 \cdot serv \cdot 0)\\
\widehat{wellbeing}_{acct} &= -3.4    + (12.3 \cdot serv)\\
\end{align}
$$


When $envt = 1$ (urban):

$$
\begin{align}
\widehat{wellbeing}_{mng} &= -3.4    + (12.3 \cdot serv)     + (20.3 \cdot envt)    + (-9.6 \cdot serv \cdot envt)\\
\widehat{wellbeing}_{mng} &= -3.4    + (12.3 \cdot serv)     + (20.3 \cdot 1)    + (-9.6 \cdot serv \cdot 1)\\
\widehat{wellbeing}_{mng} &= -3.4 + 20.3   + (12.3 \cdot serv) + (-9.6 \cdot serv)\\
\widehat{wellbeing}_{mng} &= 16.9   + (12.3 \cdot serv) + (-9.6 \cdot serv)\\
\widehat{wellbeing}_{mng} &= 16.9   + ((12.3 - 9.6) \cdot serv) \\
\widehat{wellbeing}_{mng} &= 16.9   + (2.7 \cdot serv)\\
\end{align}
$$


### in R

When envt = 0 (nature):

```{r}
coef(m2)[['(Intercept)']]  # intercept
coef(m2)[['outdoor_time']]      # slope
```


When envt = 1 (urban)

```{r}
coef(m2)[['(Intercept)']] + coef(m2)[['envturban']]      # intercept
coef(m2)[['outdoor_time']] + coef(m2)[['outdoor_time:envturban']]  # slope
```




## Plot asis model

```{r warning = F}
plot_m2_probe <- probe_interaction(
  model = m2,
  pred = outdoor_time,
  modx = envt,
  interval = T
)$interactplot +
  geom_point(data = outdoors_probedat, size = 3) +

  NULL

plot_m2_probe
```



### Asis y-intercept plot

```{r}
m2_simple_effs <- tibble(
  envt = c('nature', 'urban'),
  modx_group = c('nature', 'urban'),
  int = c(
    coef(m2)[['(Intercept)']], 
    coef(m2)[['(Intercept)']] + coef(m2)[['envturban']]
    ),
  slp = c(
    coef(m2)[['outdoor_time']],
    coef(m2)[['outdoor_time']] + coef(m2)[['outdoor_time:envturban']]
    )
)

plot_m2_probe_intercept <- plot_m2_probe
plot_m2_probe_intercept$layers[[1]] <- NULL

plot_m2_probe_intercept +
  xlim(-7, 7) +
  ylim(-10, 100) +
  geom_abline(
    data = m2_simple_effs, 
    aes(intercept = int, slope = slp, colour = envt, linetype = envt),
    linewidth = 1.5
  ) +
  geom_point(
    data = m2_simple_effs,
    x = 0,
    aes(y = int),
    size = 5,
    shape = 15
  ) +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  labs(
    subtitle = 'outdoor_time as-is'
  ) +
  theme(
    legend.position = 'bottom'
  ) +
  NULL
```



# Min-shift predictor

Plot predictor as-is.

```{r}
outdoors |>
  ggplot(aes(x = outdoor_time, y = wellbeing)) +
  geom_vline(xintercept = 0, colour = 'red', linewidth = 2) +
  geom_point() +
  NULL
```


Plot min-shifted predictor.

```{r}
outdoors <- outdoors |>
  mutate(
    outdoor_time_min = outdoor_time - min(outdoor_time)
  )

outdoors |>
  ggplot(aes(x = outdoor_time_min, y = wellbeing)) +
  geom_vline(xintercept = 0, colour = 'red', linewidth = 2) +
  geom_point() +
  NULL
```

0 is meaningful now = the minimum length of outdoor_time.


## Model

```{r}
m3 <- lm(wellbeing ~ outdoor_time_min + envt + outdoor_time_min:envt, data = outdoors)
summary(m3)
```

## Compute simple slopes

### In R

When envt = 0 (acct):

```{r}
coef(m3)[['(Intercept)']]  # intercept
coef(m3)[['outdoor_time_min']]      # slope
```


When envt = 1 (mng)

```{r}
coef(m3)[['(Intercept)']] + coef(m3)[['envturban']]      # intercept
coef(m3)[['outdoor_time_min']] + coef(m3)[['outdoor_time_min:envturban']]  # slope
```




## Plot shifted model

```{r warning=F}
outdoors_probedat <- outdoors_probedat |>
  mutate(
    outdoor_time_min = outdoor_time - min(outdoor_time)
  )

plot_m3_probe <- probe_interaction(
  model = m3,
  pred = outdoor_time_min,
  modx = envt,
  interval = T
)$interactplot +
  geom_point(data = outdoors_probedat, size = 3)

plot_m3_probe
```

### Shifted y-intercept plot

```{r}
m3_simple_effs <- tibble(
  envt = c('nature', 'urban'),
  modx_group = c('nature', 'urban'),
  int = c(
    coef(m3)[['(Intercept)']], 
    coef(m3)[['(Intercept)']] + coef(m3)[['envturban']]
    ),
  slp = c(
    coef(m3)[['outdoor_time_min']],
    coef(m3)[['outdoor_time_min']] + coef(m3)[['outdoor_time_min:envturban']]
    )
)

plot_m3_probe_intercept <- plot_m3_probe
plot_m3_probe_intercept$layers[[1]] <- NULL

plot_m3_probe_intercept +
  xlim(-7, 7) +
    ylim(-10, 100) +
  geom_abline(
    data = m3_simple_effs, 
    aes(intercept = int, slope = slp, colour = envt, linetype = envt),
    linewidth = 1.5
  ) +
  geom_point(
    data = m3_simple_effs,
    x = 0,
    aes(y = int),
    size = 5,
    shape = 15
  ) +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  labs(
    subtitle = 'outdoor_time min-shifted'
  ) +
  theme(
    legend.position = 'bottom'
  ) +
  NULL
```




# Centre predictor

Plot centered predictor.

```{r}
outdoors <- outdoors |>
  mutate(
    outdoor_time_c = scale(outdoor_time, center = TRUE, scale = FALSE)
  )

outdoors |>
  ggplot(aes(x = outdoor_time_c, y = wellbeing)) +
  geom_vline(xintercept = 0, colour = 'red', linewidth = 2) +
  geom_point() +
  NULL
```

```{r}
round(mean(outdoors$outdoor_time_c))
```


## Model

```{r}
m4 <- lm(wellbeing ~ outdoor_time_c + envt + outdoor_time_c:envt, data = outdoors)
summary(m4)
```


## Plot centered model

```{r warning = F}
outdoors_probedat <- outdoors_probedat |>
  mutate(
    outdoor_time_c = scale(outdoor_time, center = TRUE, scale = FALSE)
  )

plot_m4_probe <- probe_interaction(
  model = m4,
  pred = outdoor_time_c,
  modx = envt,
  interval = T
)$interactplot +
  geom_point(data = outdoors_probedat, size = 3)
plot_m4_probe
```


### Centered y-intercept plot

```{r}
m4_simple_effs <- tibble(
  envt = c('nature', 'urban'),
  modx_group = c('nature', 'urban'),
  int = c(
    coef(m4)[['(Intercept)']], 
    coef(m4)[['(Intercept)']] + coef(m4)[['envturban']]
    ),
  slp = c(
    coef(m4)[['outdoor_time_c']],
    coef(m4)[['outdoor_time_c']] + coef(m4)[['outdoor_time_c:envturban']]
    )
)

plot_m4_probe_intercept <- plot_m4_probe
plot_m4_probe_intercept$layers[[1]] <- NULL

plot_m4_probe_intercept +
  xlim(-7, 7) +
    ylim(-10, 100) +
  geom_abline(
    data = m4_simple_effs, 
    aes(intercept = int, slope = slp, colour = envt, linetype = envt),
    linewidth = 1.5
  ) +
  geom_point(
    data = m4_simple_effs,
    x = 0,
    aes(y = int),
    size = 5,
    shape = 15
  ) +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  labs(
    subtitle = 'outdoor_time mean-centered'
  ) +
  theme(
    legend.position = 'bottom'
  ) +
  NULL
```


# Compare coef estims

## As-is

With `outdoor_time` as-is:

```{r}
summary(m2)$coefficients |> round(3)
```


## Min-shifted

With `outdoor_time` min-shifted:

```{r}
summary(m3)$coefficients |> round(3)
```


## Centered

With `outdoor_time` mean-centered:

```{r}
summary(m4)$coefficients |> round(3)
```


# Appendix

- all simple slope calculations for all models




